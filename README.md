# Audio transcoder

[![CircleCI](https://circleci.com/gh/upstandfm/audio-transcoder.svg?style=svg)](https://circleci.com/gh/upstandfm/audio-transcoder)

Convert audio into different formats.

## Table of contents

- [Development](#development)
- [Monitoring](#monitoring)
- [CI/CD](#cicd)

## Development

### Code linting and formatting

Code is automatically linted and formatted on commit, using [ESLint](https://eslint.org/) and [Prettier](https://prettier.io/).

### Available scripts

In the project directory, you can run:

#### `npm test`

Runs all (unit) tests.

#### `npm run lint`

Lints all code using ESLint.

#### `npm run lint:format`

Lints all code using ESLint, and formats it using Prettier.

#### `npm run sls:debug`

Prints the `serverless.yaml` configuration.

## Monitoring

A [Serverless dashboard](https://dashboard.serverless.com/tenants/upstandfm/applications/audio-transcoder/services/audio-transcoder/stage/prod/region/eu-central-1#service-overview=overview) has been setup for:

- Alerts (errors)
- RED metrics
- Basic observability based on:
  - Date & time
  - Function name
  - Execution duration
  - Memory usage
  - Cold start time
  - Errors

## CI/CD

[CircleCI](https://circleci.com/gh/organizations/upstandfm) is used to:

- Audit npm dependencies for security vulnerabilities.
- Run unit/integration tests (Jest).
- Deploy services via [Serverless Framework](https://serverless.com).

### Serverless Framework

CircleCI requires a "Serverless Personal Access Key" to deploy services. This is configured as an environment variable named `SERVERLESS_ACCESS_KEY` in the [CircleCI credentials context](https://circleci.com/gh/organizations/upstandfm/settings#contexts/400c57df-2f9a-46e3-88d8-dd598b88fd19).
The value of the access key can be found in the [1Password](https://1password.com/) "Upstand FM" vault under "Serverless access key for CircleCI".

The access key allows the Serverless CLI (used by CircleCI in the `release` job) to authenticate with the Serverless Framework Dashboard.<br/>
Additionally, an [access role](https://serverless.com/framework/docs/dashboard/access-roles/) has been configured to help secure resource deployments on AWS, by enabling the Serverless Framework to issue _temporary_ AWS access keys to deploy resources. These keys are generated by Serverless Framework on every command, and the credentials expire after one hour.

> The Serverless Framework leverages AWS Security Token Service and the AssumeRole API to automate creating and usage of temporary credentials, so your developers can stay productive and work securely without doing this manually.

We also use a separate CloudFormation role to limit access during deployment, to only the required set of permissions needed by Serverless to deploy resources (i.e. no `AdministratorAccess`). This is done by setting `provider.cfnRole` in the Serverless manifest.
